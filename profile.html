<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile</title>
    <link href="./style.css" rel="stylesheet" />
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='8' fill='%233b82f6'/%3E%3Cg stroke='%23fff' stroke-width='4'%3E%3Cline x1='14' y1='12' x2='14' y2='52'/%3E%3Cline x1='24' y1='12' x2='24' y2='52'/%3E%3Cline x1='34' y1='12' x2='34' y2='52'/%3E%3Cline x1='42' y1='12' x2='42' y2='52'/%3E%3Cline x1='50' y1='12' x2='50' y2='52'/%3E%3C/g%3E%3C/svg%3E"
    />
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto max-w-2xl py-8">
      <header
        class="mb-8 flex justify-between justify-items-center items-center gap-2"
      >
        <button
          type="button"
          onclick="window.history.back()"
          class="w-2 h-2"
          aria-label="Go back"
        >
          <i data-lucide="arrow-left" class="h-5 w-5 text-gray-500"></i>
          <span class="sr-only">Back</span>
        </button>
        <h1 class="text-2xl font-bold text-gray-800">Profile</h1>
        <span></span>
      </header>

      <form
        id="profile-form"
        class="bg-white rounded-2xl shadow-lg p-6 flex flex-col gap-4"
      >
        <div>
          <label class="block text-sm font-semibold mb-1" for="profile-name"
            >Name</label
          >
          <input id="profile-name" type="text" class="form-input" />
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1" for="profile-phone"
            >Phone</label
          >
          <input id="profile-phone" type="text" class="form-input" />
        </div>
        <div>
          <label
            class="block text-sm font-semibold mb-1"
            for="default-label-size"
            >Default Label Size</label
          >
          <select id="default-label-size" class="form-select">
            <option value="30mm">30mm</option>
            <option value="40mm">40mm</option>
            <option value="50mm">50mm</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1" for="default-copies"
            >Default Copies</label
          >
          <input id="default-copies" type="number" min="1" class="form-input" />
        </div>
        <button type="submit" class="btn-primary">Save Settings</button>
        <button type="button" id="logout-btn" class="btn-secondary mt-2">
          Logout
        </button>
      </form>
    </div>
    <div id="profile-feedback" class="text-center text-green-600 mt-4 hidden">
      Settings saved!
    </div>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="bottom-nav.js"></script>
    <script src="profile.js"></script>
    <script>
      renderBottomNav("profile");
      // Profile page logic
      const userId = localStorage.getItem("userId");
      if (!userId) window.location.href = "index.html";

      const form = document.getElementById("profile-form");
      const feedback = document.getElementById("profile-feedback");
      const logoutBtn = document.getElementById("logout-btn");

      // Fetch user details from backend and fill fields
      async function loadUserDetails() {
        try {
          const res = await fetch(`/api/user?userId=${userId}`);
          if (!res.ok) throw new Error("Failed to load user");
          const user = await res.json();
          document.getElementById("profile-name").value = user.username || "";
          document.getElementById("profile-phone").value = user.phone || "";
        } catch (e) {
          // fallback: leave blank
        }
      }

      // Load user settings from localStorage
      function loadSettings() {
        const settings = JSON.parse(
          localStorage.getItem(`settings_${userId}`) || "{}"
        );
        document.getElementById("default-label-size").value =
          settings.labelSize || "30mm";
        document.getElementById("default-copies").value = settings.copies || 1;
      }

      form.addEventListener("submit", function (e) {
        e.preventDefault();
        const name = document.getElementById("profile-name").value.trim();
        const phone = document.getElementById("profile-phone").value.trim();
        const labelSize = document.getElementById("default-label-size").value;
        const copies =
          parseInt(document.getElementById("default-copies").value) || 1;
        const settings = { name, phone, labelSize, copies };
        localStorage.setItem(`settings_${userId}`, JSON.stringify(settings));
        feedback.classList.remove("hidden");
        setTimeout(() => feedback.classList.add("hidden"), 2000);
      });

      logoutBtn.addEventListener("click", function () {
        localStorage.removeItem("userId");
        window.location.href = "index.html";
      });

      loadUserDetails();
      loadSettings();

      // Render bottom nav with active state
      if (typeof renderBottomNav === "function") {
        renderBottomNav("profile");
      } else {
        window.addEventListener("DOMContentLoaded", function () {
          if (typeof renderBottomNav === "function") renderBottomNav("profile");
        });
      }
    </script>
  </body>
</html>
