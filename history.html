<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Barcode History</title>
    <link href="./style.css" rel="stylesheet" />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"
      defer
    ></script>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto max-w-2xl py-8">
      <header class="text-center mb-8">
        <h1 class="text-2xl font-bold text-gray-800">Barcode History</h1>
      </header>
      <div class="mb-6">
        <input
          id="history-search"
          type="text"
          class="form-input w-full"
          placeholder="Search by value, name, or label size..."
        />
      </div>
      <div class="overflow-x-auto">
        <table
          class="min-w-full bg-white rounded-xl shadow border border-gray-300 table-auto"
        >
          <thead>
            <tr class="bg-gray-100">
              <th
                class="px-4 py-3 text-left text-xs font-semibold text-gray-600 border-b border-gray-300 whitespace-nowrap"
              >
                Barcode
              </th>
              <th
                class="px-4 py-3 text-left text-xs font-semibold text-gray-600 border-b border-gray-300 whitespace-nowrap"
              >
                Value
              </th>
              <th
                class="px-4 py-3 text-left text-xs font-semibold text-gray-600 border-b border-gray-300 whitespace-nowrap"
              >
                Name
              </th>
              <th
                class="px-4 py-3 text-left text-xs font-semibold text-gray-600 border-b border-gray-300 whitespace-nowrap"
              >
                Label Size
              </th>
              <th
                class="px-4 py-3 text-left text-xs font-semibold text-gray-600 border-b border-gray-300 whitespace-nowrap"
              >
                Copies
              </th>
              <th
                class="px-4 py-3 text-left text-xs font-semibold text-gray-600 border-b border-gray-300 whitespace-nowrap"
              >
                Date
              </th>
              <th
                class="px-4 py-3 text-left text-xs font-semibold text-gray-600 border-b border-gray-300 whitespace-nowrap"
              >
                Action
              </th>
            </tr>
          </thead>
          <tbody id="history-list" class="divide-y divide-gray-200"></tbody>
        </table>
      </div>
      <div id="empty-history" class="text-center py-8 text-gray-500 hidden">
        <p>No barcodes found.</p>
      </div>
    </div>
    <script>
      // Redirect to login if not logged in
      const userId = localStorage.getItem("userId");
      if (!userId) {
        window.location.href = "index.html";
      }

      let history = [];
      const historyList = document.getElementById("history-list");
      const emptyHistory = document.getElementById("empty-history");
      const searchInput = document.getElementById("history-search");

      async function fetchHistory() {
        try {
          const res = await fetch(`/api/history?userId=${userId}`);
          if (!res.ok) throw new Error("Failed to load history");
          history = await res.json();
          renderHistory();
        } catch (e) {
          history = [];
          renderHistory();
        }
      }

      function renderHistory(filter = "") {
        const filtered = history.filter((item) => {
          const q = filter.toLowerCase();
          return (
            item.value.toLowerCase().includes(q) ||
            (item.name && item.name.toLowerCase().includes(q)) ||
            (item.labelSize && item.labelSize.toLowerCase().includes(q))
          );
        });
        if (filtered.length === 0) {
          historyList.innerHTML = `<tr><td colspan='7' class='text-center py-8 text-gray-500'>No barcodes found.</td></tr>`;
          emptyHistory.classList.add("hidden");
          return;
        }
        emptyHistory.classList.add("hidden");
        historyList.innerHTML = filtered
          .map((item) => {
            // Generate barcode image
            const tempCanvas = document.createElement("canvas");
            try {
              JsBarcode(tempCanvas, item.value, {
                format: "UPC",
                width: 2,
                height: 80,
                displayValue: false,
                margin: 0,
              });
            } catch (e) {}
            const barcodeImage = tempCanvas.toDataURL();
            return `
              <tr class="even:bg-gray-50 odd:bg-white border-b border-gray-200">
                <td class="px-4 py-3 border-r border-gray-200 whitespace-nowrap"><img src="${barcodeImage}" alt="Barcode" class="h-12 w-auto mx-auto" /></td>
                <td class="px-4 py-3 border-r border-gray-200 font-mono text-sm text-gray-800 whitespace-nowrap">${
                  item.value
                }</td>
                <td class="px-4 py-3 border-r border-gray-200 text-sm text-primary-500 font-semibold whitespace-nowrap">${
                  item.name || ""
                }</td>
                <td class="px-4 py-3 border-r border-gray-200 text-xs text-gray-500 whitespace-nowrap">${
                  item.labelSize
                }</td>
                <td class="px-4 py-3 border-r border-gray-200 text-xs text-gray-500 whitespace-nowrap">${
                  item.copies
                }</td>
                <td class="px-4 py-3 border-r border-gray-200 text-xs text-gray-400 whitespace-nowrap">${new Date(
                  item.timestamp
                ).toLocaleDateString()}</td>
                <td class="px-4 py-3 whitespace-nowrap"><button class="btn-secondary text-xs px-3 py-2 w-full" onclick="reprintBarcode('${
                  item.value
                }')">Reprint</button></td>
              </tr>
            `;
          })
          .join("");
      }

      searchInput.addEventListener("input", (e) => {
        renderHistory(e.target.value);
      });

      window.reprintBarcode = function (value) {
        // Open print dialog for the barcode
        const printWindow = window.open("", "_blank");
        printWindow.document.write(`
        <html>
          <head>
            <title>Print Barcode</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
              .barcode-container { margin: 20px 0; page-break-inside: avoid; }
              .barcode-value { font-family: monospace; margin-top: 10px; font-size: 14px; }
              @media print { body { margin: 0; } }
            </style>
            <script src='https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js'><\/script>
          </head>
          <body>
            <div class="barcode-container">
              <canvas id="barcode-canvas"></canvas>
              <div class="barcode-value">${value}</div>
            </div>
            <script>
              JsBarcode(document.getElementById('barcode-canvas'), '${value}', { format: 'UPC', width: 2, height: 100, displayValue: true, fontSize: 14, margin: 10 });
              window.print();
            <\/script>
          </body>
        </html>
      `);
        printWindow.document.close();
        printWindow.focus();
      };

      // Hide scrollbars
      document.querySelector("body").style.scrollbarWidth = "none";
      document.querySelector("body").style.msOverflowStyle = "none";

      fetchHistory();
    </script>
  </body>
</html>
